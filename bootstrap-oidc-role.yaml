AWSTemplateFormatVersion: '2010-09-09'
Description: 'Bootstrap IAM Role for Akara Studio GitHub Actions OIDC Deployment'

Parameters:
  GitHubOrg:
    Type: String
    Default: 'amitbikrath'
    Description: 'GitHub organization or username'
  GitHubRepo:
    Type: String
    Default: 'akara-aws-deploy'
    Description: 'GitHub repository name'
  ProjectName:
    Type: String
    Default: 'akara'
    Description: 'Project name for resource naming'

Resources:
  # GitHub OIDC Identity Provider
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1
        - 1c58a3a8518e8759bf075b76b750d4f2df264fcd
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-github-oidc'
        - Key: Project
          Value: !Ref ProjectName

  # IAM Role for GitHub Actions
  GitHubActionsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-github-actions-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref GitHubOIDCProvider
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                'token.actions.githubusercontent.com:aud': sts.amazonaws.com
              StringLike:
                'token.actions.githubusercontent.com:sub': !Sub 'repo:${GitHubOrg}/${GitHubRepo}:*'
      ManagedPolicyArns:
        - !Ref AkaraDeploymentPolicy
      MaxSessionDuration: 3600
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-github-actions-role'
        - Key: Project
          Value: !Ref ProjectName

  # Custom IAM Policy with admin permissions
  AkaraDeploymentPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${ProjectName}-deployment-policy'
      Description: 'Admin policy for Akara Studio deployment'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AdminAll
            Effect: Allow
            Action: "*"
            Resource: "*"

Outputs:
  GitHubActionsRoleArn:
    Description: 'ARN of the GitHub Actions IAM Role'
    Value: !GetAtt GitHubActionsRole.Arn
    Export:
      Name: !Sub '${ProjectName}-github-actions-role-arn'

  OIDCProviderArn:
    Description: 'ARN of the GitHub OIDC Provider'
    Value: !Ref GitHubOIDCProvider
    Export:
      Name: !Sub '${ProjectName}-oidc-provider-arn'

  DeploymentInstructions:
    Description: 'Next steps for deployment'
    Value: !Sub |
      1. Copy the GitHub Actions Role ARN: ${GitHubActionsRole.Arn}
      2. Add this ARN to your GitHub repository secrets as AWS_ROLE_ARN
      3. Trigger the GitHub Actions workflow to deploy your infrastructure
      4. The role has least-privilege permissions for S3, CloudFront, DynamoDB, Cognito, and other AWS services needed for Akara Studio

